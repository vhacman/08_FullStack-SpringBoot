<div class="w3-container w3-padding-large">

  <div class="booking-header-box">
    <div style="display:flex; align-items:center; gap:12px;">
      <img src="img/iconaInsertGuest.png" alt="Inserisci prenotazione" class="header-icon">
      <h2 class="page-title" style="margin:0;">Nuova Prenotazione</h2>
    </div>
  </div>

  <form class="booking-form" #bookingForm="ngForm" (ngSubmit)="submit()">

    <!-- 1. Selezione ospite — sempre visibile -->
    <app-guest-picker (guestSelected)="onGuestSelected($event)"></app-guest-picker>
    <div class="form-hint">
      Ospite non trovato? <a routerLink="/insert-guest">Inserisci nuovo ospite</a>
    </div>

    <!-- 2. Date — compaiono solo dopo aver selezionato un ospite -->
    @if (guestSelected()) {
      <div class="form-row">
        <div class="form-group">
          <label><i class="fa fa-sign-in"></i> Check-in</label>
          <input type="date"
                 [min]="today"
                 [value]="checkIn()"
                 (change)="onCheckInChange($any($event.target).value)"
                 class="form-input">
        </div>
        <div class="form-group">
          <label><i class="fa fa-sign-out"></i> Check-out</label>
          <input type="date"
                 [min]="minCheckOut()"
                 [value]="checkOut()"
                 (change)="onCheckOutChange($any($event.target).value)"
                 class="form-input">
        </div>
      </div>

      @if (nights() > 0) {
        <div class="msg-info">
          <i class="fa fa-moon-o"></i> {{ nights() }} nott{{ nights() === 1 ? 'e' : 'i' }}
        </div>

        <!-- RoomPicker: mostra automaticamente le camere libere per l'hotel dell'utente loggato -->
        <app-room-picker
          [checkIn]="checkIn()"
          [checkOut]="checkOut()"
          (roomSelected)="onRoomSelected($event)">
        </app-room-picker>
      }
    }

    <!-- 3. Dettagli prenotazione — compaiono solo dopo aver selezionato una camera -->
    @if (selectedRoom()) {
      <div class="form-group">
        <label>Prezzo (€)</label>
        <input type="number" name="price" [ngModel]="price()" (ngModelChange)="price.set($event)" required min="0" class="form-input">
      </div>

      <div class="total-cost">
        TOTAL: {{ totalCost() }} € (COMPUTED)
      </div>

      <div class="form-group">
        <label>Note</label>
        <textarea name="notes" [(ngModel)]="form.notes" rows="2"
                  placeholder="Opzionale..." class="form-input"></textarea>
      </div>

      @if (success()) {
        <div class="msg-success">
          <i class="fa fa-check-circle"></i> Prenotazione salvata con successo!
        </div>
      }
      @if (errorMessage()) {
        <div class="msg-error">
          <i class="fa fa-exclamation-circle"></i> {{ errorMessage() }}
        </div>
      }

      <div class="form-actions">
        <button type="submit" class="btn-submit"
                [disabled]="!guestSelected() || form.roomId === 0">
          <i class="fa fa-save"></i> Salva
        </button>
        <button type="button" class="btn-reset" (click)="reset()">
          <i class="fa fa-undo"></i> Reset
        </button>
      </div>
    }
  </form>
</div>
