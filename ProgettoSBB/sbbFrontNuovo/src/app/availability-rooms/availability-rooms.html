<div class="w3-container w3-padding-large">
  <div class="page-header">
    <i class="bi bi-door-open header-icon"></i>
    <h2>Stanze dell'Hotel</h2>
  </div>

  <!-- Spinner durante il caricamento iniziale delle camere -->
  @if (loading()) {
    <div class="w3-center w3-padding">
      Caricamento...
    </div>
  } @else {

    <!-- Chip di filtro: TUTTE / DISPONIBILI / OCCUPATE / DA PULIRE
         countFor() mostra il numero di camere per ogni stato -->
    <div class="filter-chips">
      @for (f of filters; track f.value) {
        <button
          class="chip"
          [class.active]="activeFilter() === f.value"
          (click)="setFilter(f.value)">
          {{ f.label }}
          <span class="chip-count">{{ countFor(f.value) }}</span>
        </button>
      }
    </div>

    <!-- Griglia delle camere filtrate -->
    <div class="rooms-grid">
      @for (room of filtered(); track room.id) {

        <!-- getStatusClass() aggiunge una classe CSS colorata in base allo stato -->
        <div class="room-card w3-card-2" [class]="getStatusClass(room.status)">
          <div class="room-name">{{ room.name }}</div>

          <!-- Badge colorato per lo stato della camera -->
          <div class="room-status">
            @switch (room.status) {
              @case ('AVAILABLE') {
                <span class="badge badge-available">Disponibile</span>
              }
              @case ('OCCUPIED') {
                <span class="badge badge-occupied">Occupata</span>
              }
              @case ('TO_CLEAN') {
                <span class="badge badge-to-clean">Da pulire</span>
              }
            }
          </div>

          <div class="room-description">{{ room.description }}</div>
          <div class="room-price">{{ room.basePrice }} €/notte</div>

          <!-- Il pulsante "Prenota" appare solo se la camera è AVAILABLE.
               hasActiveBooking() controlla se esiste già una prenotazione PENDING:
               in quel caso mostra un avviso invece del pulsante. -->
          @if (room.status === 'AVAILABLE') {
            @if (hasActiveBooking(room.id!)) {
              <div class="booking-warning">
                Prenotazione per questa stanza non ancora check-in
              </div>
            } @else {
              <button class="btn-book" (click)="openBookingModal(room)">
                Prenota
              </button>
            }
          }

        </div>
      }
    </div>
  }
</div>

<!-- Modal di prenotazione: visibile solo quando showModal() è true.
     Il click sull'overlay chiude il modal; stopPropagation() impedisce
     che il click sul contenuto lo propaghi all'overlay e lo chiuda. -->
@if (showModal()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content w3-card-2" (click)="$event.stopPropagation()">

      <div class="modal-header">
        <h3>Prenotazione - {{ selectedRoom()?.name }}</h3>
        <button class="modal-close" (click)="closeModal()">&times;</button>
      </div>

      <div class="modal-body">

        <!-- Messaggio di successo dopo il salvataggio -->
        @if (bookingSuccess()) {
          <div class="msg-success">
            Prenotazione salvata con successo!
          </div>
        } @else {

          <!-- Step 1: cerca l'ospite. Se non trovato, appare il form di inserimento -->
          <div class="form-group">
            <label>Cerca Ospite</label>
            <app-guest-picker
              (guestSelected)="onGuestReady($event)"
              (guestNotFound)="onGuestNotFound($event)">
            </app-guest-picker>
          </div>

          @if (showInsertGuest()) {
            <app-insert-guest (guestCreated)="onGuestReady($event)"></app-insert-guest>
          }

          <!-- Step 2: date (visibile solo dopo aver selezionato un ospite) -->
          @if (guestId()) {
            <div class="form-row">
              <div class="form-group">
                <label>Check-in</label>
                <!-- $any($event.target).value: cast necessario perché Angular
                     non conosce il tipo di $event.target nel template -->
                <input type="date"
                       [value]="checkIn()"
                       (change)="onCheckInChange($any($event.target).value)"
                       class="form-input">
              </div>
              <div class="form-group">
                <label>Check-out</label>
                <input type="date"
                       [value]="checkOut()"
                       (change)="onCheckOutChange($any($event.target).value)"
                       class="form-input">
              </div>
            </div>

            <!-- Step 3: prezzo e note (visibili solo se le date formano almeno 1 notte) -->
            @if (nights > 0) {
              <div class="msg-info">
                <!-- Plurale condizionale: "1 notte" / "2 notti" -->
                {{ nights }} notte{{ nights === 1 ? '' : 'i' }}
              </div>

              <div class="form-group">
                <label>Prezzo (€)</label>
                <!-- ngModel in due direzioni: [ngModel] legge il Signal, (ngModelChange) lo aggiorna -->
                <input type="number"
                       [ngModel]="price()"
                       (ngModelChange)="price.set($event)"
                       class="form-input">
              </div>

              <div class="total-cost">
                TOTAL: {{ totalCost }} €
              </div>

              <div class="form-group">
                <label>Note</label>
                <textarea [ngModel]="notes()"
                          (ngModelChange)="notes.set($event)"
                          rows="2"
                          placeholder="Opzionale..."
                          class="form-input"></textarea>
              </div>

              @if (bookingError()) {
                <div class="msg-error">{{ bookingError() }}</div>
              }

              <div class="form-actions">
                <button class="btn-submit" (click)="submitBooking()">Salva</button>
                <button class="btn-reset" (click)="closeModal()">Annulla</button>
              </div>
            }
          }
        }
      </div>
    </div>
  </div>
}
